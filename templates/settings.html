{% extends "base.html" %}
{% block title %}Ayarlar • Financhatting{% endblock %}

{% block content %}
<div class="page">
  <div class="page-head">
    <div>
      <h1 class="page-title">⚙️ Profil Ayarları</h1>
      <p class="page-subtitle">İsim, bio, avatar seçimi (UI Avatars / hazır avatar)</p>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label class="field">
        <span>Ad Soyad</span>
        <input id="fullName" placeholder="Örn: Mustafa Çelik" />
      </label>

      <label class="field">
        <span>Kullanıcı adı</span>
        <input id="username" placeholder="mehmet" disabled />
        <small>Username v2’de değişmez (Twitter mantığı).</small>
      </label>
    </div>

    <label class="field">
      <span>Bio</span>
      <textarea id="bio" rows="4" maxlength="200" placeholder="Kısa bio..."></textarea>
      <div class="small" id="bioCount">0/200</div>
    </label>

    <div class="card-sub">
      <h3>Avatar</h3>
      <div class="avatars">
        <button class="pill active" data-mode="ui">UI Avatars</button>
        <button class="pill" data-mode="preset">Hazır Avatar</button>
        <button class="pill" data-mode="upload" disabled title="v2.1">Upload (v2.1)</button>
      </div>

      <div id="modeUi" class="mode">
        <div class="hint">İsimden otomatik avatar üretir. (önerilen)</div>
        <div class="preview">
          <img id="uiPreview" alt="ui" />
          <div class="small">Kaydet dediğinde avatar otomatik güncellenir.</div>
        </div>
      </div>

      <div id="modePreset" class="mode" style="display:none;">
        <div class="hint">Hazır avatar seç (örnek set). İstersen seti büyütürüz.</div>
        <div class="preset-grid" id="presetGrid"></div>
      </div>

      <div id="modeUpload" class="mode" style="display:none;">
        <div class="hint">Upload v2.1 (Cloudinary/S3) ile açılacak.</div>
      </div>
    </div>

    <div class="actions">
      <div id="msg" class="msg" style="display:none;"></div>
      <button class="btn btn-primary" id="btnSave">Kaydet</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .page{max-width:900px;margin:0 auto;padding:10px 6px 40px;}
  .page-title{font-size:2.2em;color:var(--green);margin:0 0 6px;text-shadow:0 0 20px rgba(16,185,129,.25);}
  .page-subtitle{margin:0;color:var(--muted);}
  .card{
    margin-top:16px;
    background: linear-gradient(145deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
  .field span{color:var(--muted);font-weight:900;}
  input, textarea{
    border:1px solid var(--border);
    background: rgba(15,23,42,.35);
    color:var(--text);
    border-radius:14px;
    padding:12px 14px;
    outline:none;
    font-family:inherit;
  }
  textarea{resize:vertical;}
  small,.small{color:var(--muted2);font-size:.9em;}
  .card-sub{
    border-top:1px solid rgba(51,65,85,.75);
    margin-top:10px; padding-top:14px;
  }
  .card-sub h3{margin:0 0 10px;color:var(--text);}
  .avatars{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
  .pill{
    border:1px solid var(--border);background: rgba(15,23,42,.35);
    color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;
    transition: transform .15s ease,border-color .2s ease, box-shadow .2s ease; user-select:none;
  }
  .pill:hover{transform:translateY(-1px);border-color:rgba(59,130,246,.55);box-shadow:0 10px 24px rgba(59,130,246,.10);}
  .pill.active{color:var(--text);border-color:rgba(16,185,129,.75);box-shadow:0 10px 24px rgba(16,185,129,.10);}
  .pill[disabled]{opacity:.45;cursor:not-allowed;}
  .hint{color:var(--muted2);margin-bottom:10px;}
  .preview{display:flex;gap:14px;align-items:center;flex-wrap:wrap;}
  .preview img{width:72px;height:72px;border-radius:18px;border:1px solid var(--border);}
  .preset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(72px,1fr));gap:10px;max-width:520px;}
  .preset{
    border:1px solid var(--border);
    background: rgba(15,23,42,.25);
    border-radius:16px;
    padding:8px;
    cursor:pointer;
    display:grid;place-items:center;
    transition: transform .15s ease,border-color .2s ease;
  }
  .preset:hover{transform:translateY(-1px);border-color:rgba(16,185,129,.55);}
  .preset img{width:56px;height:56px;border-radius:14px;}
  .actions{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:14px;}
  .msg{padding:10px 12px;border-radius:12px;border:1px solid rgba(16,185,129,.55);background:rgba(16,185,129,.08);color:var(--green);font-weight:800;}
  @media(max-width:800px){.row{grid-template-columns:1fr}}
</style>
{% endblock %}

{% block extra_js %}
<script>
  const $=(q)=>document.querySelector(q);
  const $$=(q)=>Array.from(document.querySelectorAll(q));
  function avatarUrl(name){const n=encodeURIComponent((name||"User").replaceAll(" ","+"));return `https://ui-avatars.com/api/?name=${n}&background=0f172a&color=10b981&size=256`;}
  async function apiGet(url){const r=await fetch(url,{credentials:"include"}); if(!r.ok) throw new Error(await r.text()); return await r.json();}
  async function apiPost(url,payload){const r=await fetch(url,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload||{})}); if(!r.ok) throw new Error(await r.text()); return await r.json();}

  let avatarMode = "ui";     // ui | preset | upload
  let presetSelected = null; // url

  const presetUrls = [
    "https://ui-avatars.com/api/?name=Neo&background=1e293b&color=3b82f6&size=256",
    "https://ui-avatars.com/api/?name=Alpha&background=0f172a&color=10b981&size=256",
    "https://ui-avatars.com/api/?name=GS&background=0f172a&color=f59e0b&size=256",
    "https://ui-avatars.com/api/?name=Wolf&background=111827&color=ef4444&size=256",
    "https://ui-avatars.com/api/?name=Khan&background=0b1220&color=22c55e&size=256",
    "https://ui-avatars.com/api/?name=TR&background=1f2937&color=e2e8f0&size=256",
  ];

  function setMode(m){
    avatarMode = m;
    $$(".avatars .pill").forEach(x=>x.classList.remove("active"));
    $(`.avatars .pill[data-mode="${m}"]`)?.classList.add("active");
    $("#modeUi").style.display = (m==="ui") ? "block" : "none";
    $("#modePreset").style.display = (m==="preset") ? "block" : "none";
    $("#modeUpload").style.display = (m==="upload") ? "block" : "none";
  }

  function renderPresets(){
    const grid = $("#presetGrid");
    grid.innerHTML = presetUrls.map(url => `
      <div class="preset" data-url="${url}">
        <img alt="preset" src="${url}">
      </div>
    `).join("");
    $$("#presetGrid .preset").forEach(el=>{
      el.onclick = ()=>{
        presetSelected = el.getAttribute("data-url");
        $$("#presetGrid .preset").forEach(x=>x.style.borderColor="var(--border)");
        el.style.borderColor = "rgba(16,185,129,.75)";
      };
    });
  }

  function showMsg(t){
    const m=$("#msg");
    m.textContent=t;
    m.style.display="block";
    setTimeout(()=>m.style.display="none", 3500);
  }

  async function loadMe(){
    // expected: GET /api/me
    const me = await apiGet("/api/me");
    $("#fullName").value = me.full_name || "";
    $("#username").value = me.username || "";
    $("#bio").value = me.bio || "";
    $("#bioCount").textContent = `${($("#bio").value||"").length}/200`;
    $("#uiPreview").src = avatarUrl(me.full_name || me.username);
  }

  async function save(){
    const full_name = ($("#fullName").value||"").trim();
    const bio = ($("#bio").value||"").trim();

    const avatar_url = (avatarMode==="preset" && presetSelected)
      ? presetSelected
      : avatarUrl(full_name || $("#username").value);

    // expected: POST /api/settings/profile
    await apiPost("/api/settings/profile", {
      full_name, bio,
      avatar_mode: avatarMode,
      avatar_url
    });

    showMsg("Kaydedildi ✅");
    $("#uiPreview").src = avatarUrl(full_name || $("#username").value);
  }

  // wiring
  $$(".avatars .pill").forEach(b=>{
    if(b.hasAttribute("disabled")) return;
    b.onclick = ()=> setMode(b.getAttribute("data-mode"));
  });
  $("#bio").addEventListener("input", ()=> $("#bioCount").textContent = `${($("#bio").value||"").length}/200`);
  $("#btnSave").onclick = save;

  renderPresets();
  setMode("ui");
  loadMe().catch(()=>showMsg("Ayarlar için giriş yapman gerekiyor."));
</script>
{% endblock %}