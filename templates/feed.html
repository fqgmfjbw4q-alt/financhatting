<!-- templates/feed.html -->
{% extends "base.html" %}

{% block title %}Feed ‚Ä¢ Financhatting{% endblock %}

{% block content %}
<div class="page">
  <div class="page-head">
    <div>
      <h1 class="page-title">üì∞ Feed</h1>
      <p class="page-subtitle">Kullanƒ±cƒ± payla≈üƒ±mlarƒ± + %20 ve √ºst√º fiyat deƒüi≈üim uyarƒ±larƒ±</p>
    </div>

    <div class="page-actions">
      <button class="btn btn-ghost" id="btnRefresh" title="Yenile">‚Üª</button>
    </div>
  </div>

  <!-- Compose -->
  <div class="card composer">
    <div class="composer-top">
      <div class="avatar" id="meAvatar" title="Profil">
        <img id="meAvatarImg" alt="avatar" />
      </div>

      <div class="composer-box">
        <textarea id="postContent" rows="3" maxlength="800" placeholder="Takip√ßilerine payla≈üƒ±m yap... (√∂rn: BTC kƒ±rƒ±lƒ±m geldi, hedeflerim...)"></textarea>

        <div class="composer-meta">
          <div class="composer-left">
            <label class="chip">
              <span>üìå Sembol (opsiyonel)</span>
              <select id="postSymbol">
                <option value="">Se√ßme</option>
                <option value="BTC">BTC</option>
                <option value="GOLD">GOLD</option>
                <option value="SILVER">SILVER</option>
                <option value="USDTRY">USDTRY</option>
                <option value="EURTRY">EURTRY</option>
                <option value="BIST100">BIST100</option>
              </select>
            </label>

            <label class="chip" title="(v2.1) Foto y√ºkleme">
              <span>üñºÔ∏è Foto</span>
              <input id="postImage" type="file" accept="image/*" disabled />
            </label>
            <span class="hint">Foto y√ºkleme v2.1‚Äôde (Cloudinary/S3).</span>
          </div>

          <div class="composer-right">
            <span class="counter" id="counter">0/800</span>
            <button class="btn btn-primary" id="btnPost">Payla≈ü</button>
          </div>
        </div>
      </div>
    </div>

    <div class="composer-error" id="composerError" style="display:none;"></div>
  </div>

  <!-- Feed filters -->
  <div class="filters">
    <button class="pill active" data-filter="all">T√ºm√º</button>
    <button class="pill" data-filter="posts">Payla≈üƒ±mlar</button>
    <button class="pill" data-filter="alerts">Alert</button>
    <button class="pill" data-filter="hot">En Etkile≈üimli</button>
  </div>

  <!-- Feed list -->
  <div id="feedList" class="feed-list">
    <div class="loading">
      <div class="spinner"></div>
      <p>Feed y√ºkleniyor...</p>
    </div>
  </div>

  <div id="feedError" class="error-message" style="display:none;"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .page { max-width: 1100px; margin: 0 auto; padding: 10px 6px 40px; }
  .page-head { display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin: 8px 0 18px; }
  .page-title { font-size: 2.2em; color: var(--green); margin: 0 0 6px; text-shadow: 0 0 20px rgba(16, 185, 129, 0.25); }
  .page-subtitle { margin:0; color: var(--muted); }
  .page-actions { display:flex; gap:10px; }

  .card {
    background: linear-gradient(145deg, var(--panel) 0%, var(--panel2) 100%);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  /* Composer */
  .composer { padding: 18px; margin-bottom: 16px; }
  .composer-top { display:flex; gap:14px; }
  .avatar { width: 46px; height: 46px; border-radius: 14px; overflow:hidden; border:1px solid var(--border); flex: 0 0 auto; }
  .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
  .composer-box { flex: 1; }
  textarea {
    width: 100%;
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    color: var(--text);
    border-radius: 14px;
    padding: 14px;
    outline: none;
    resize: vertical;
    min-height: 84px;
    font-family: inherit;
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  textarea:focus { border-color: rgba(16, 185, 129, 0.75); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.08); }

  .composer-meta { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
  .composer-left { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
  .composer-right { display:flex; align-items:center; gap: 10px; }
  .hint { color: var(--muted2); font-size: .9em; }

  .chip {
    display:flex; align-items:center; gap:10px;
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    padding: 10px 12px;
    border-radius: 999px;
    color: var(--muted);
    font-size: .95em;
  }
  .chip select {
    background: transparent;
    border: none;
    color: var(--text);
    outline: none;
    font-weight: 600;
  }
  .chip input[type="file"] { width: 160px; color: var(--muted); }

  .counter { color: var(--muted2); font-variant-numeric: tabular-nums; font-size: .92em; }

  .composer-error {
    margin-top: 12px;
    background: rgba(239, 68, 68, 0.12);
    border: 1px solid rgba(239, 68, 68, 0.65);
    color: #fca5a5;
    padding: 12px 14px;
    border-radius: 12px;
  }

  /* Filters */
  .filters { display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 18px; }
  .pill {
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    color: var(--muted);
    padding: 10px 14px;
    border-radius: 999px;
    cursor: pointer;
    transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease;
    user-select: none;
  }
  .pill:hover { transform: translateY(-1px); border-color: rgba(59, 130, 246, 0.55); box-shadow: 0 10px 24px rgba(59, 130, 246, 0.10); }
  .pill.active { color: var(--text); border-color: rgba(16, 185, 129, 0.75); box-shadow: 0 10px 24px rgba(16, 185, 129, 0.10); }

  /* Feed */
  .feed-list { display:flex; flex-direction:column; gap: 14px; }
  .feed-item { padding: 16px 18px; }
  .feed-head { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 12px; }
  .who { display:flex; align-items:center; gap: 10px; min-width: 0; }
  .who .mini-avatar { width: 36px; height: 36px; border-radius: 12px; overflow:hidden; border:1px solid var(--border); flex: 0 0 auto; }
  .who .mini-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
  .who .meta { min-width: 0; }
  .who .name { font-weight: 800; color: var(--text); line-height: 1.1; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 360px; }
  .who .sub { color: var(--muted2); font-size: .92em; display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
  .badge {
    display:inline-flex; align-items:center; gap:6px;
    padding: 3px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    color: var(--muted);
    font-size: .85em;
    font-weight: 700;
  }
  .badge.green { border-color: rgba(16,185,129,.55); color: var(--green); }
  .badge.blue  { border-color: rgba(59,130,246,.55); color: var(--blue); }
  .badge.red   { border-color: rgba(239,68,68,.55); color: #ef4444; }

  .content { color: var(--text); line-height: 1.55; white-space: pre-wrap; word-break: break-word; }
  .content a { color: var(--blue); text-decoration: none; }
  .content a:hover { text-decoration: underline; }

  .media { margin-top: 12px; border-radius: 14px; overflow: hidden; border:1px solid var(--border); }
  .media img { width:100%; display:block; }

  .actions { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(51,65,85,0.75); flex-wrap:wrap; }
  .left-actions { display:flex; align-items:center; gap: 12px; flex-wrap: wrap; }
  .right-actions { display:flex; align-items:center; gap: 10px; }

  /* Stars */
  .stars { display:inline-flex; gap: 6px; align-items:center; }
  .star-btn {
    width: 34px; height: 34px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    cursor: pointer;
    display:grid; place-items:center;
    transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease;
    user-select:none;
  }
  .star-btn:hover { transform: translateY(-1px); border-color: rgba(16,185,129,.55); box-shadow: 0 10px 18px rgba(16,185,129,.08); }
  .star-btn.active { border-color: rgba(16,185,129,.75); }
  .stars-count { color: var(--muted2); font-variant-numeric: tabular-nums; font-size: .92em; }

  .link {
    color: var(--muted);
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.35);
    padding: 8px 12px;
    border-radius: 999px;
    text-decoration:none;
    font-weight: 700;
    transition: transform .15s ease, border-color .2s ease;
  }
  .link:hover { transform: translateY(-1px); border-color: rgba(59,130,246,.55); color: var(--text); }

  .loading { text-align:center; padding: 40px 0; color: var(--muted2); }
  .spinner {
    border: 3px solid var(--border);
    border-top: 3px solid var(--green);
    border-radius: 50%;
    width: 38px;
    height: 38px;
    animation: spin 1s linear infinite;
    margin: 0 auto 14px;
  }
  @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

  .error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    color: #fca5a5;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    margin: 10px 0;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .page-title { font-size: 1.8em; }
    .who .name { max-width: 200px; }
    .composer { padding: 14px; }
    .feed-item { padding: 14px; }
    .star-btn { width: 32px; height: 32px; border-radius: 11px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // ---- Helpers
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  function escHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtTime(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString("tr-TR");
    } catch { return ""; }
  }

  function avatarUrl(fullNameOrUsername) {
    const name = encodeURIComponent((fullNameOrUsername || "User").replaceAll(" ", "+"));
    return `https://ui-avatars.com/api/?name=${name}&background=0f172a&color=10b981&size=128`;
  }

  function showComposerError(msg) {
    const el = $("#composerError");
    el.textContent = msg;
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 4500);
  }

  // ---- State
  let currentFilter = "all";

  // ---- API calls
  async function apiGet(url) {
    const r = await fetch(url, { credentials: "include" });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function apiPost(url, payload) {
    const r = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload || {})
    });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  // ---- Render
  function buildStars({ kind, id, myStars, avgStars, count }) {
    const safeKind = kind === "alert" ? "alert" : "post";
    const safeId = Number(id);

    const wrap = document.createElement("div");
    wrap.className = "stars";
    wrap.setAttribute("data-kind", safeKind);
    wrap.setAttribute("data-id", safeId);

    for (let s = 1; s <= 5; s++) {
      const b = document.createElement("div");
      b.className = "star-btn" + (myStars === s ? " active" : "");
      b.title = `${s} yƒ±ldƒ±z`;
      b.textContent = "‚òÖ";
      b.onclick = async () => {
        try {
          // Endpoint'leri backend'de a√ßacaƒüƒ±z:
          // POST /api/rate  { kind:"post"|"comment"|"alert", id: 123, stars: 1..5 }
          const res = await apiPost("/api/rate", { kind: safeKind, id: safeId, stars: s });
          // res: { avg: 4.2, count: 31, my: 5 } gibi
          // UI g√ºncelle
          updateStarsUI(wrap, res.my, res.avg, res.count);
        } catch (e) {
          // giri≈ü yoksa veya endpoint yoksa sessiz kalmayalƒ±m
          showComposerError("Oylama i√ßin giri≈ü yapman gerekebilir (veya endpoint hen√ºz aktif deƒüil).");
        }
      };
      wrap.appendChild(b);
    }

    const c = document.createElement("span");
    c.className = "stars-count";
    c.textContent = `Ort: ${Number(avgStars || 0).toFixed(1)} ‚Ä¢ Oy: ${count || 0}`;
    wrap.appendChild(c);

    return wrap;
  }

  function updateStarsUI(starsWrap, my, avg, count) {
    const btns = Array.from(starsWrap.querySelectorAll(".star-btn"));
    btns.forEach((b, idx) => {
      const s = idx + 1;
      b.classList.toggle("active", my === s);
    });
    const c = starsWrap.querySelector(".stars-count");
    if (c) c.textContent = `Ort: ${Number(avg || 0).toFixed(1)} ‚Ä¢ Oy: ${count || 0}`;
  }

  function renderFeedItem(item) {
    // item shape (hedef):
    // {
    //   type: "post" | "alert",
    //   id: 123,
    //   created_at: "...",
    //   user: { username:"mehmet", full_name:"Mehmet Bostancƒ±" } (post i√ßin),
    //   content: "...",
    //   symbol_key: "BTC" (opsiyonel),
    //   image_url: "..." (opsiyonel),
    //   alert: { symbol_key:"BTC", change_pct: 21.3, window:"1d", price: 41234.1 } (alert i√ßin),
    //   rating: { avg: 4.3, count: 12, my: 5 }
    // }

    const card = document.createElement("div");
    card.className = "card feed-item";

    const isAlert = item.type === "alert";
    const created = fmtTime(item.created_at);

    const whoName = isAlert ? "Financhatting Alert" : (item.user?.full_name || item.user?.username || "Kullanƒ±cƒ±");
    const whoUser = isAlert ? "@system" : ("@" + (item.user?.username || "user"));

    const avatar = isAlert ? avatarUrl("Alert") : avatarUrl(whoName);

    const symbolBadge = (item.symbol_key || item.alert?.symbol_key)
      ? `<span class="badge blue">#${escHtml(item.symbol_key || item.alert?.symbol_key)}</span>`
      : "";

    let typeBadge = "";
    if (isAlert) {
      const pct = Number(item.alert?.change_pct || 0);
      const cls = pct >= 0 ? "green" : "red";
      typeBadge = `<span class="badge ${cls}">‚ö° ${pct.toFixed(2)}%</span>`;
    } else {
      typeBadge = `<span class="badge green">üìù Post</span>`;
    }

    const titleRight = `<div class="sub">
        ${typeBadge}
        ${symbolBadge}
        <span class="badge">${created}</span>
      </div>`;

    const content = isAlert
      ? (() => {
          const sym = escHtml(item.alert?.symbol_key || "");
          const pct = Number(item.alert?.change_pct || 0).toFixed(2);
          const price = item.alert?.price != null ? `‚Ä¢ Fiyat: ${Number(item.alert.price).toLocaleString("tr-TR")}` : "";
          const w = escHtml(item.alert?.window || "1d");
          return `üì£ <b>${sym}</b> i√ßin <b>%${pct}</b> deƒüi≈üim uyarƒ±sƒ± (${w}) ${price}\n\nGrafiƒüi g√∂rmek i√ßin sembol sayfasƒ±na gidebilirsin.`;
        })()
      : escHtml(item.content || "");

    const linkTo = (item.symbol_key || item.alert?.symbol_key)
      ? `/s/${encodeURIComponent(item.symbol_key || item.alert.symbol_key)}`
      : (isAlert ? "#" : `/@${encodeURIComponent(item.user?.username || "")}`);

    const linkLabel = (item.symbol_key || item.alert?.symbol_key) ? "Sembol Sayfasƒ±" : "Profil";

    card.innerHTML = `
      <div class="feed-head">
        <div class="who">
          <div class="mini-avatar"><img alt="avatar" src="${avatar}"></div>
          <div class="meta">
            <div class="name">${escHtml(whoName)}</div>
            <div class="sub">
              <span>${escHtml(whoUser)}</span>
            </div>
          </div>
        </div>
        <div>${titleRight}</div>
      </div>

      <div class="content">${content.replaceAll("\n","<br>")}</div>

      ${item.image_url ? `<div class="media"><img alt="media" src="${escHtml(item.image_url)}"></div>` : ""}

      <div class="actions">
        <div class="left-actions">
          <a class="link" href="${linkTo}">üîé ${linkLabel}</a>
          ${(item.symbol_key || item.alert?.symbol_key) ? `<a class="link" href="/s/${encodeURIComponent(item.symbol_key || item.alert.symbol_key)}#comments">üí¨ Yorumlara Git</a>` : ``}
        </div>
        <div class="right-actions" id="starsMount"></div>
      </div>
    `;

    const mount = card.querySelector("#starsMount");
    const rating = item.rating || {};
    mount.appendChild(buildStars({
      kind: isAlert ? "alert" : "post",
      id: item.id,
      myStars: rating.my || null,
      avgStars: rating.avg || 0,
      count: rating.count || 0
    }));

    return card;
  }

  function setLoading() {
    $("#feedList").innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <p>Feed y√ºkleniyor...</p>
      </div>
    `;
    $("#feedError").style.display = "none";
  }

  function setError(msg) {
    const el = $("#feedError");
    el.textContent = msg;
    el.style.display = "block";
    $("#feedList").innerHTML = "";
  }

  // ---- Load feed
  async function loadFeed() {
    setLoading();
    try {
      // Backend'de ≈üu endpoint olacak:
      // GET /api/feed?filter=all|posts|alerts|hot
      const data = await apiGet(`/api/feed?filter=${encodeURIComponent(currentFilter)}`);

      const list = $("#feedList");
      list.innerHTML = "";

      if (!data || !Array.isArray(data.items) || data.items.length === 0) {
        list.innerHTML = `
          <div class="card feed-item">
            <div class="content" style="color:var(--muted)">Hen√ºz i√ßerik yok. ƒ∞lk payla≈üƒ±mƒ± sen yap üòÑ</div>
          </div>`;
        return;
      }

      for (const item of data.items) {
        list.appendChild(renderFeedItem(item));
      }
    } catch (e) {
      console.error(e);
      setError("Feed y√ºklenemedi. (API hen√ºz eklenmemi≈ü olabilir.)");
    }
  }

  // ---- Create post
  async function createPost() {
    const content = ($("#postContent").value || "").trim();
    const symbol = ($("#postSymbol").value || "").trim();
    if (!content) return showComposerError("Payla≈üƒ±m bo≈ü olamaz.");

    try {
      $("#btnPost").disabled = true;
      // Backend'de ≈üu endpoint olacak:
      // POST /api/posts { content, symbol_key }
      await apiPost("/api/posts", { content, symbol_key: symbol || null });
      $("#postContent").value = "";
      $("#postSymbol").value = "";
      $("#counter").textContent = "0/800";
      await loadFeed();
    } catch (e) {
      console.error(e);
      showComposerError("Payla≈üƒ±m g√∂nderilemedi. Giri≈ü yapman gerekebilir (veya endpoint hen√ºz aktif deƒüil).");
    } finally {
      $("#btnPost").disabled = false;
    }
  }

  // ---- UI wiring
  function wireFilters() {
    $$(".pill").forEach(p => {
      p.onclick = async () => {
        $$(".pill").forEach(x => x.classList.remove("active"));
        p.classList.add("active");
        currentFilter = p.getAttribute("data-filter") || "all";
        await loadFeed();
      };
    });
  }

  function wireComposer() {
    const ta = $("#postContent");
    ta.addEventListener("input", () => {
      const n = (ta.value || "").length;
      $("#counter").textContent = `${n}/800`;
    });
    $("#btnPost").onclick = createPost;
  }

  function wireRefresh() {
    $("#btnRefresh").onclick = loadFeed;
  }

  async function loadMe() {
    // Backend'de ≈üu endpoint olacak:
    // GET /api/me -> { username, full_name }
    try {
      const me = await apiGet("/api/me");
      const name = me?.full_name || me?.username || "User";
      $("#meAvatarImg").src = avatarUrl(name);
    } catch {
      // giri≈ü yoksa
      $("#meAvatarImg").src = avatarUrl("Guest");
    }
  }

  // init
  wireFilters();
  wireComposer();
  wireRefresh();
  loadMe();
  loadFeed();

  // Feed'i sƒ±k sƒ±k yenileme: (opsiyonel)
  setInterval(loadFeed, 30000);
</script>
{% endblock %}