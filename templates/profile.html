{% extends "base.html" %}
{% block title %}Profil â€¢ Financhatting{% endblock %}

{% block content %}
<div class="page">
  <div class="card hero">
    <div class="hero-left">
      <div class="avatar">
        <img id="avatarImg" alt="avatar" />
      </div>
      <div class="who">
        <div class="name" id="fullName">YÃ¼kleniyor...</div>
        <div class="handle" id="handle">@...</div>
        <div class="bio" id="bio"> </div>
        <div class="stats">
          <span class="badge blue" id="followers">ðŸ‘¥ 0 takipÃ§i</span>
          <span class="badge" id="following">âž• 0 takip</span>
        </div>
      </div>
    </div>

    <div class="hero-right">
      <button class="btn btn-primary" id="btnFollow" style="display:none;">Takip Et</button>
      <a class="btn btn-ghost" id="btnEdit" href="/settings" style="display:none;">Profili DÃ¼zenle</a>
    </div>
  </div>

  <div class="tabs">
    <button class="pill active" data-tab="posts">GÃ¶nderiler</button>
    <button class="pill" data-tab="comments">Yorumlar</button>
  </div>

  <div id="tabPosts" class="list"></div>
  <div id="tabComments" class="list" style="display:none;"></div>

  <div id="profileError" class="error-message" style="display:none;"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .page{max-width:1100px;margin:0 auto;padding:10px 6px 40px;}
  .card{
    background: linear-gradient(145deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--border);
    border-radius:16px;
    overflow:hidden;
  }
  .hero{padding:18px;display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;}
  .hero-left{display:flex;gap:14px;align-items:flex-start;min-width:0;}
  .avatar{width:70px;height:70px;border-radius:18px;overflow:hidden;border:1px solid var(--border);flex:0 0 auto;}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
  .who{min-width:0;}
  .name{font-weight:1000;color:var(--text);font-size:1.55em;line-height:1.1;}
  .handle{color:var(--muted);font-weight:900;margin-top:6px;}
  .bio{color:var(--muted2);margin-top:10px;white-space:pre-wrap;line-height:1.5;}
  .stats{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;}
  .badge{
    display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;
    border:1px solid var(--border);background: rgba(15,23,42,.35);
    color:var(--muted);font-size:.9em;font-weight:800;
  }
  .badge.blue{border-color:rgba(59,130,246,.55);color:var(--blue);}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;}
  .pill{
    border:1px solid var(--border);background: rgba(15,23,42,.35);
    color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;
    transition: transform .15s ease,border-color .2s ease, box-shadow .2s ease; user-select:none;
  }
  .pill:hover{transform:translateY(-1px);border-color:rgba(59,130,246,.55);box-shadow:0 10px 24px rgba(59,130,246,.10);}
  .pill.active{color:var(--text);border-color:rgba(16,185,129,.75);box-shadow:0 10px 24px rgba(16,185,129,.10);}
  .list{display:flex;flex-direction:column;gap:12px;}
  .item{
    margin-top:10px;
    border:1px solid rgba(51,65,85,.85);
    background: rgba(15,23,42,.25);
    border-radius:16px;
    padding:16px;
  }
  .head{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
  .small{color:var(--muted2);font-size:.92em;}
  .content{color:var(--text);white-space:pre-wrap;line-height:1.55;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px;}
  .link{color:var(--muted);text-decoration:none;font-weight:900;border:1px solid var(--border);background: rgba(15,23,42,.35);padding:8px 12px;border-radius:999px;}
  .link:hover{color:var(--text);border-color:rgba(59,130,246,.55);}
  .error-message{background:rgba(239,68,68,.1);border:1px solid #ef4444;color:#fca5a5;padding:15px;border-radius:10px;text-align:center;margin:10px 0;}
</style>
{% endblock %}

{% block extra_js %}
<script>
  const $=(q)=>document.querySelector(q);
  const $$=(q)=>Array.from(document.querySelectorAll(q));
  function esc(s){return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}
  function avatarUrl(name){const n=encodeURIComponent((name||"User").replaceAll(" ","+"));return `https://ui-avatars.com/api/?name=${n}&background=0f172a&color=10b981&size=256`;}
  async function apiGet(url){const r=await fetch(url,{credentials:"include"}); if(!r.ok) throw new Error(await r.text()); return await r.json();}
  async function apiPost(url,payload){const r=await fetch(url,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload||{})}); if(!r.ok) throw new Error(await r.text()); return await r.json();}

  const username = "{{ username|default('') }}";

  function showError(msg){const e=$("#profileError"); e.textContent=msg; e.style.display="block";}

  function renderPost(p){
    const sym = p.symbol_key ? `<span class="link">#${esc(p.symbol_key)}</span>` : "";
    const rating = p.rating ? `â˜… ${(Number(p.rating.avg||0)).toFixed(1)} â€¢ Oy ${Number(p.rating.count||0)}` : "";
    return `
      <div class="item">
        <div class="head">
          <div class="small">${new Date(p.created_at).toLocaleString("tr-TR")}</div>
          <div class="small">${esc(rating)}</div>
        </div>
        <div class="content">${esc(p.content||"")}</div>
        <div class="row">
          ${sym}
          ${p.symbol_key ? `<a class="link" href="/s/${encodeURIComponent(p.symbol_key)}">Sembol</a>` : ""}
        </div>
      </div>
    `;
  }

  function renderComment(c){
    return `
      <div class="item">
        <div class="head">
          <div class="small">${new Date(c.created_at).toLocaleString("tr-TR")}</div>
          <div class="small">#${esc(c.symbol_key||"")}</div>
        </div>
        <div class="content">${esc(c.content||"")}</div>
        <div class="row">
          <a class="link" href="/s/${encodeURIComponent(c.symbol_key||"")}#comments">Sembol SayfasÄ±</a>
        </div>
      </div>
    `;
  }

  async function loadProfile(){
    try{
      $("#profileError").style.display="none";
      // expected: GET /api/profile/<username>
      const data = await apiGet(`/api/profile/${encodeURIComponent(username)}`);

      $("#fullName").textContent = data.full_name || data.username || username;
      $("#handle").textContent = "@"+(data.username||username);
      $("#bio").textContent = data.bio || "";
      $("#followers").textContent = `ðŸ‘¥ ${Number(data.followers||0)} takipÃ§i`;
      $("#following").textContent = `âž• ${Number(data.following||0)} takip`;

      $("#avatarImg").src = data.avatar_url || avatarUrl(data.full_name || data.username);

      // Edit / Follow buttons
      if (data.is_me){
        $("#btnEdit").style.display = "inline-flex";
      } else {
        $("#btnFollow").style.display = "inline-flex";
        $("#btnFollow").textContent = data.is_following ? "Takibi BÄ±rak" : "Takip Et";
        $("#btnFollow").onclick = async ()=>{
          try{
            const res = await apiPost("/api/follow", { username: data.username, action: data.is_following ? "unfollow" : "follow" });
            data.is_following = res.is_following;
            $("#btnFollow").textContent = data.is_following ? "Takibi BÄ±rak" : "Takip Et";
            $("#followers").textContent = `ðŸ‘¥ ${Number(res.followers||data.followers||0)} takipÃ§i`;
          }catch(e){
            showError("Takip iÅŸlemi baÅŸarÄ±sÄ±z. GiriÅŸ yapman gerekebilir.");
          }
        };
      }

      // Lists
      const postsEl = $("#tabPosts");
      postsEl.innerHTML = "";
      const posts = data.posts || [];
      postsEl.innerHTML = posts.length ? posts.map(renderPost).join("") : `<div class="item"><div class="small">HenÃ¼z paylaÅŸÄ±m yok.</div></div>`;

      const commentsEl = $("#tabComments");
      commentsEl.innerHTML = "";
      const comments = data.comments || [];
      commentsEl.innerHTML = comments.length ? comments.map(renderComment).join("") : `<div class="item"><div class="small">HenÃ¼z yorum yok.</div></div>`;

    }catch(e){
      console.error(e);
      showError("Profil yÃ¼klenemedi. (API henÃ¼z eklenmemiÅŸ olabilir.)");
    }
  }

  // tabs
  $$(".pill").forEach(b=>{
    b.onclick = ()=>{
      $$(".pill").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const tab = b.getAttribute("data-tab");
      $("#tabPosts").style.display = (tab==="posts") ? "flex" : "none";
      $("#tabComments").style.display = (tab==="comments") ? "flex" : "none";
    };
  });

  loadProfile();
</script>
{% endblock %}